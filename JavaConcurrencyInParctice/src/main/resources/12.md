# 并发测试

并发测试分为2大类：安全性和活跃性

安全性：不发生错误的行为；测试不变性条件
活跃性：某个良好的行为终会发生：进展测试和无进展测试；包括测试吞吐量，响应性，可伸缩性

## 正确性测试

见BoundBuffer,一个固定长度的数组，put和take方法都阻塞来，并通过两个信号量来控制。不推荐自己编写，直接用ArrayBlockingQueue，LinkedBlockingQueue

### 基本的单元测试

见BoundBufferTest

### 对阻塞操作的测试

要测试一个阻塞，类似于测试一个抛出异常的方法：如果方法可以返回意味着测试失败。同时还要考虑阻塞以后使方法接触阻塞。简单的方法是使用中断，启动阻塞，阻塞以后中断它。
Thread.getState并不可靠。被阻塞线程不需要进入Waiting或者Time——waiting，JVM可以通过自旋来实现阻塞。

### 安全性测试

多个线程执行put和take。但是测试程序自身就是并发程序，要开发一个良好的并发测试，或许比开发这些程序要测试的类更难。

在构建并发类的安全测试时，需要解决的关键问题是，要找出那些容易检查的属性，这些属性在发生错误的情况下极有可能失败，同时又不会使得错误检查代码人为地
限制并发现。理想情况是，在测试属性中不需要任何同步机制。

比较好的方法是，通过一个对顺序敏感的校验和计算函数来计算所有入列元素以及出列元素的校验和，并比较。若是多个生产者-消费者，则将多个值比较，尽量减少同步代码。
其次，不要使用连续的整数，因为编译器会提前知道结果。但是注意有些随机数生产器是线程安全的，因此会产生耦合关系。推荐自己写一个随机数函数。见xorShift.

见PutTakeTest,如果boundbuffer里的插入或者释放没有同步，就会报错，其次运行时也尽量在多处理器上运行，其次线程数量要大于cpu数量，这样才会切换线程。

### 资源管理的测试

见Big,如果泄露，值的差距会非常大。

### 使用回调

回调函数的执行通常是在对象生命周期的已知位置，适合用不变性条件测试。

测试线程池：需要测试，需要线程时创建，不需要时销毁，以及回收操作等。见TestingThreadFactory

### 产生更多的交替操作

提高交替操作的数量，可以使用Thread.yield来产生更多的交替操作。当然测试完成后要删除这部分代码。

## 性能测试

### 在putTakeTest上增加计时功能

见在putTakeTest,可知
1.  生产者和消费者在不同参数组合下的吞吐率
2.  有界缓存在不同线程数量下的可伸缩性
3.  如何选择缓存大小

性能不光和线程数有关，还和容量大小有关

### 多种算法的比较

链表结构在并发下的性能更优秀

### 响应性衡量

会发现容量很影响响应性

## 避免性能测试的陷阱

### 垃圾回收

### 动态编译

如果一个运行的次数很多，编译器会把它编译成机器码。

### 对代码路径的不真实采样

### 不真实的竞争程度

### 无用代码的消除

## 其他测试方法

### 代码审查

### 静态分析工具

lint，findbugs

### AOP

aop来切同步代码块

### 分析与监测工具









